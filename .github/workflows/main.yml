name: Free VPS with 8GB RAM and Saved Storage

on:
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      # Use GITHUB_TOKEN for same-repo releases, or GH_PAT for cross-repo
      GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
      RELEASE_TAG: v1.0.0
      RELEASE_TITLE: "Free VPS with 8GB RAM and Saved Storage"
      RELEASE_NOTES: "Auto-created release for Free VPS workflow"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update packages
        run: sudo apt update

      - name: Install QEMU, socat, and Tailscale
        run: |
          sudo apt install -y qemu-system qemu-utils socat curl wget zip xz-utils cloud-utils
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update
          sudo apt install -y tailscale
          sudo tailscaled &

      - name: Free disk space
        run: |
          sudo bash -c '
          rm -rf /opt/*
          for d in /usr/local/lib/android /usr/share/dotnet /opt/ghc \
            /usr/local/share/chromium /usr/local/share/firefox /usr/local/share/edge; do
            rm -rf $d
          done
          rm -rf /opt/hostedtoolcache/* /tmp/* /var/tmp/*
          apt-get clean -y
          '

      - name: Connect with Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: sudo tailscale up --authkey $TS_AUTHKEY --accept-routes

      - name: Ensure release exists
        run: |
          if ! gh release view $RELEASE_TAG; then
            echo "Release $RELEASE_TAG not found. Creating..."
            gh release create $RELEASE_TAG --title "$RELEASE_TITLE" --notes "$RELEASE_NOTES"
          else
            echo "Release $RELEASE_TAG already exists."
          fi

      - name: Download existing image parts
        run: |
          echo "Downloading existing parts..."
          gh release download $RELEASE_TAG --pattern "windows_part_*" || true
          if ls windows_part_* 1> /dev/null 2>&1; then
            echo "Rebuilding windows.zip from parts..."
            cat windows_part_* > windows.zip
            rm -rf windows_part_*
            unzip windows.zip || true
            rm -rf windows.zip
          fi

      - name: Show disk space
        run: df -h /

      - name: Prepare base image if needed
        run: |
          if [ ! -f "windows.img" ]; then
             qemu-img create -f raw windows.img 25G
             wget "https://archive.org/download/tiny-10-23-h2/tiny10%20x64%2023h2.iso" -O windows.iso 
             touch cdrom
          fi

      - name: Boot the VM
        run: |
          if [ -f "cdrom" ]; then
            sudo qemu-system-x86_64 \
              -enable-kvm -cpu host -m 8G -smp 4 \
              -hda windows.img \
              -cdrom windows.iso -vnc :2 \
              -net user,hostfwd=tcp::2222-:22 -net nic \
              -monitor unix:/tmp/qemu-monitor.sock,server,nowait -daemonize
          else
            sudo qemu-system-x86_64 \
              -enable-kvm -cpu host -m 8G -smp 4 \
              -hda windows.img \
              -vnc :2 -net user,hostfwd=tcp::3389-:3389 -net nic \
              -monitor unix:/tmp/qemu-monitor.sock,server,nowait -daemonize
          fi

      - name: Keep VM running
        run: sleep 14400

      - name: Gracefully shutdown VM
        run: |
          set +e
          if [ -f "/tmp/qemu-monitor.sock" ]; then
            sudo socat - UNIX-CONNECT:/tmp/qemu-monitor.sock <<< "system_powerdown"
          fi

      - name: Compress and split image
        run: |
          echo "Compressing windows.img..."
          zip windows.zip windows.img
          rm -rf windows.img
          echo "Splitting into 1GB parts..."
          split -b 1024M windows.zip windows_part_

      - name: Upload missing parts to release
        run: |
          for f in windows_part_*; do
              echo "Uploading $f..."
              gh release upload $RELEASE_TAG "$f" --clobber
          done

          
